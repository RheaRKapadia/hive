<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/style.css">
    <title>New Workouts</title>
</head>
<body class="newworkout">
  <header>
      <div class="logo">
          <h1>HIVE</h1>
      </div>
      <nav>
          <div class="user-menu">
              <a href="/user/userprofile">
                  <img src="/images/avatar.png" alt="User Avatar" class="avatar">
              </a>
              <span>Menu</span>
          </div>
      </nav>
  </header>
  <div class="page-content">
    <div class="fixed-content">
        <h1>New Routine</h1>
        <div class="search-bar">
            <input type="text" class="search-input" placeholder="Search Workouts">
            <a href="/<%= userId %>/workouts/new/ai" class="personalized-workout" aria-label="Menu">Personalized Workout</a>
        </div>
        <span>Filter</span>
        <select id="bodyPartFilter" class="filter-button">
          <option value="">Body Part</option>
          <option value="back">Back</option>
          <option value="cardio">Cardio</option>
          <option value="chest">Chest</option>
          <option value="lower_arms">Lower Arms</option>
          <option value="lower_legs">Lower Legs</option>
          <option value="neck">Neck</option>
          <option value="shoulders">Shoulders</option>
          <option value="upper_arms">Upper Arms</option>
          <option value="upper_legs">Upper Legs</option>
          <option value="waist">Waist</option>
        </select>
        <select id="equipmentFilter" class="filter-button">
          <option value="">Equipment</option>
          <!-- Equipment options here -->
        </select>
        <select id="targetFilter" class="filter-button">
          <option value="">Target Area</option>
          <!-- Target area options here -->
        </select>
    </div>
    <div class="selected-exercises">
      <h2>Selected Exercises</h2>
      <div class="workout-info">
        <div class="workout-name-container">
          <input type="text" id="workoutName" placeholder="Workout Name" required>
        </div>
        <div class="workout-location-container">
          <select id="workoutLocation" required>
            <option value="" disabled selected>Select Location</option>
            <option value="gym">Gym</option>
            <option value="home">Home</option>
            <option value="other">Other</option>
          </select>
        </div>
      </div>
      <ul id="selectedExercisesList"></ul>
      <button id="submitWorkout" class="submit-button">Create Workout</button>
    </div>
    <div id="exerciseContainer" class="scrollable-content">
      <div class="workout-list">
          <div class="workout-header">
              <div>Select</div>
              <div>Exercise</div>
              <div>Description</div>
              <div>Equipment</div>
              <div>Muscles</div>
          </div>
          <% if (exercises && exercises.data && exercises.data.length > 0) { %>
            <% exercises.data.forEach(function(exercise) { %>
                <div class="workout-row">
                    <div>
                        <input type="checkbox" class="select-exercise" data-exercise-id="<%= exercise.id %>">
                    </div>
                    <div class="exercise-name">
                        <a href="#" class="exercise-link" data-exercise-id="<%= exercise.id %>"><%= exercise.name %></a>
                    </div>
                    <div class="exercise-description">
                        <p class="short-description"><%= exercise.instructions[0] %>...</p>
                        <div class="full-instructions" style="display: none;">
                            <% exercise.instructions.forEach(function(instruction) { %>
                                <p><%= instruction %></p>
                            <% }); %>
                        </div>
                    </div>
                    <div><span class="equipment-tag"><%= exercise.equipment %></span></div>
                    <div class="target-muscles">
                        <%= exercise.target %>
                        <% if (exercise.secondaryMuscles && exercise.secondaryMuscles.length > 0) { %>
                            , <%= exercise.secondaryMuscles.join(', ') %>
                        <% } %>
                    </div>
                </div>
            <% }); %>
          <% } else { %>
            <div class="no-exercises">No exercises found.</div>
          <% } %>
      </div>
    </div>
  </div>

  <!-- <div class="pagination">
      <% if (exercises.pagination.currentPage > 1) { %>
          <a href="/user/workouts/new?page=<%= exercises.pagination.currentPage - 1 %>">&laquo; Previous</a>
      <% } %>

      <% for (let i = 1; i <= exercises.pagination.totalPages; i++) { %>
          <a href="/user/workouts/new?page=<%= i %>" class="<%= exercises.pagination.currentPage === i ? 'active' : '' %>"><%= i %></a>
      <% } %>

      <% if (exercises.pagination.currentPage < exercises.pagination.totalPages) { %>
          <a href="/user/workouts/new?page=<%= exercises.pagination.currentPage + 1 %>">Next &raquo;</a>
      <% } %>
  </div> -->
  <!-- <a href="#" class="add-button">+</a> -->
  <script>
    // Pass the exercises data from the server to the client
    const exercises = <%- JSON.stringify(exercises.data) %>;
  </script>
  <script src="/js/workout-filters.js"></script>
  <script src="/js/exercise-details.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
        const exerciseContainer = document.getElementById('exerciseContainer');
        if (exerciseContainer) {
            exercises.forEach(exercise => {
                const exerciseRow = document.createElement('div');
                exerciseRow.className = 'workout-row';
                exerciseRow.innerHTML = `
                    <button class="add-exercise">+</button>
                    <div class="exercise-name">
                        <a href="#" class="exercise-link" data-exercise-id="${exercise.id}">${exercise.name}</a>
                    </div>
                    <div class="exercise-description">
                        <p class="short-description">${exercise.instructions[0]}...</p>
                        <div class="full-instructions" style="display: none;">
                            ${exercise.instructions.map(instruction => `<p>${instruction}</p>`).join('')}
                        </div>
                    </div>
                    <div><span class="equipment-tag">${exercise.equipment}</span></div>
                    <div>${exercise.target}, ${exercise.secondaryMuscles.join(', ')}</div>
                `;
                exerciseContainer.appendChild(exerciseRow);
            });
        } else {
            console.error('exerciseContainer element not found');
        }
    });
  </script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const selectedExercises = new Set();
      const selectedExercisesList = document.getElementById('selectedExercisesList');
      const submitWorkoutButton = document.getElementById('submitWorkout');
      const workoutNameInput = document.getElementById('workoutName');
      const workoutLocationSelect = document.getElementById('workoutLocation');

      // Ensure userId is passed from the server
      const userId = '<%= userId %>';

      if (selectedExercisesList) {
        document.querySelectorAll('.select-exercise').forEach(checkbox => {
          checkbox.addEventListener('change', function() {
            const exerciseId = this.dataset.exerciseId;
            const exerciseRow = this.closest('.workout-row');
            const exerciseName = exerciseRow.querySelector('.exercise-name').textContent.trim();
            const exerciseDescription = exerciseRow.querySelector('.exercise-description').textContent.trim();
            const exerciseEquipment = exerciseRow.querySelector('.equipment-tag').textContent.trim();
            const exerciseMuscles = exerciseRow.querySelector('div:last-child').textContent.trim();

            if (this.checked) {
              selectedExercises.add({
                id: exerciseId,
                name: exerciseName,
                description: exerciseDescription,
                equipment: exerciseEquipment,
                muscles: exerciseMuscles
              });
              const li = document.createElement('li');
              li.textContent = exerciseName;
              li.dataset.exerciseId = exerciseId;
              selectedExercisesList.appendChild(li);
            } else {
              selectedExercises.delete([...selectedExercises].find(e => e.id === exerciseId));
              const li = selectedExercisesList.querySelector(`li[data-exercise-id="${exerciseId}"]`);
              if (li) li.remove();
            }
          });
        });
      } else {
        console.error('selectedExercisesList element not found');
      }

      if (submitWorkoutButton) {
        submitWorkoutButton.addEventListener('click', async function() {
          if (workoutNameInput && workoutLocationSelect) {
            const workoutName = workoutNameInput.value.trim();
            const workoutLocation = workoutLocationSelect.value;

            if (workoutName && workoutLocation && selectedExercises.size > 0) {
              const response = await fetch(`/${userId}/workouts/create`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  name: workoutName,
                  location: workoutLocation,
                  exercises: Array.from(selectedExercises).map(exercise => ({
                    id: exercise.id,
                    name: exercise.name,
                    description: exercise.description,
                    equipment: exercise.equipment,
                    muscles: exercise.muscles
                  }))
                })
              });

              if (response.ok) {
                const result = await response.json();
                if (result.success) {
                  alert('Workout created successfully!');
                  window.location.href = `/${userId}/workouts`;
                } else {
                  alert('Failed to create workout. Please try again.');
                }
              } else {
                alert('Failed to create workout. Please try again.');
              }
            } else {
              alert('Please fill out all fields and select at least one exercise.');
            }
          } else {
            console.error('Workout name or location input elements not found');
          }
        });
      } else {
        console.error('submitWorkoutButton element not found');
      }
    });
  </script>
</body>
</html>
